<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>English Transcriber</title>
  <style>
    :root {
      --bg: #f9fafb;
      --card: #ffffff;
      --border: #e5e7eb;
      --text: #111827;
      --sub: #6b7280;
      --primary: #4bac4d;
      --radius: 16px;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
    }
    body {
      background: var(--bg);
      margin: 0;
      padding: 20px;
      color: var(--text);
    }

    .container {
      max-width: 750px;
      margin: auto;
      background: var(--card);
      padding: 20px;
      border-radius: var(--radius);
      box-shadow: 0 4px 16px rgba(0,0,0,0.04);
    }

    h1 {
      text-align: center;
      margin-bottom: 10px;
      font-size: 1.6rem;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-bottom: 16px;
    }

    button {
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card);
      cursor: pointer;
      font-size: 0.95rem;
      transition: 0.15s;
    }
    button.primary {
      background: var(--primary);
      color: white;
      border: none;
    }
    button:active {
      transform: scale(0.97);
    }

    .options {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 16px;
      font-size: 0.9rem;
      color: var(--sub);
    }

    .transcript-box {
      border: 1px solid var(--border);
      background: #fff;
      padding: 12px;
      height: 350px;
      overflow-y: auto;
      border-radius: 12px;
    }

    .line {
      padding: 8px 0;
      border-bottom: 1px dashed #eef2ff;
      font-size: 1.2rem;
    }

    .meter-wrap {
      margin: 12px 0;
    }

    .meter {
      width: 100%;
      height: 10px;
      background: #e5e7eb;
      border-radius: 50px;
      overflow: hidden;
    }
    .meter > i {
      display: block;
      height: 100%;
      width: 0;
      background: var(--primary);
    }

    @media (max-width: 600px) {
      h1 { font-size: 1.3rem; }
      button { font-size: 0.85rem; padding: 8px; }
      .options { flex-direction: column; }
      .transcript-box { height: 260px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>English Transcriber</h1>

    <div class="controls">
      <button id="btnStart" class="primary">Start</button>
      <button id="btnStop">Stop</button>
      <button id="btnClear">Clear</button>
      <button id="btnDownload">Download</button>
    </div>

    <div class="options">
      <label>Language:
        <select id="selLang">
          <option value="en-US">English (US)</option>
          <option value="en-GB">English (UK)</option>
        </select>
      </label>
      <label>Continuous: <input type="checkbox" id="chkContinuous" checked /></label>
      <label>Interim: <input type="checkbox" id="chkInterim" checked /></label>
      <span>Status: <strong id="statusText">idle</strong></span>
    </div>

    <div class="meter-wrap">
      <div class="meter"><i id="vu"></i></div>
    </div>

    <div id="transcript" class="transcript-box"></div>
  </div>

<script>
// Feature detection
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;
const btnStart = document.getElementById('btnStart');
const btnStop = document.getElementById('btnStop');
const btnClear = document.getElementById('btnClear');
const btnDownload = document.getElementById('btnDownload');
const selLang = document.getElementById('selLang');
const chkContinuous = document.getElementById('chkContinuous');
const chkInterim = document.getElementById('chkInterim');
const statusText = document.getElementById('statusText');
const transcriptEl = document.getElementById('transcript');
const vu = document.getElementById('vu');

let recognition = null;
let mediaStream = null;
let audioContext = null;
let analyser = null;
let rafId = null;

function appendLine(text, confidence=null, isInterim=false){
  const t = new Date();
  const time = t.toLocaleTimeString();
  const div = document.createElement('div');
  div.className = 'line';
  div.dataset.time = t.toISOString();
  div.innerHTML = `【${time}】 ${escapeHtml(text)} ${confidence?`<span style="color:#64748b">(conf:${(confidence*100).toFixed(0)}%)</span>`:''}`;
  transcriptEl.appendChild(div);
  transcriptEl.scrollTop = transcriptEl.scrollHeight;
}

function escapeHtml(s){ return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

async function startRecognition(){
  if(!SpeechRecognition){
    alert('This browser does not support the Web Speech API. Use Chrome on desktop for best results.');
    return;
  }
  recognition = new SpeechRecognition();
  recognition.lang = selLang.value;
  recognition.continuous = chkContinuous.checked;
  recognition.interimResults = chkInterim.checked;

  recognition.onstart = ()=>{ statusText.textContent = 'listening'; };
  recognition.onend = ()=>{ statusText.textContent = 'stopped';
    // if continuous is checked, restart automatically (for some browsers that stop unexpectedly)
    if(chkContinuous.checked){
      setTimeout(()=>{ try{ recognition.start(); }catch(e){} }, 250);
    }
  };

  recognition.onerror = (ev)=>{ console.warn('SpeechRecognition error', ev); statusText.textContent = 'error'; };

  recognition.onresult = (ev)=>{
    // ev.results is a SpeechRecognitionResultList
    for(let i = ev.resultIndex; i < ev.results.length; i++){
      const res = ev.results[i];
      const text = res[0].transcript.trim();
      const conf = res[0].confidence || null;
      const isInterim = res.isFinal === false;
      if(res.isFinal){ appendLine(text, conf, false); }
      else{ // show interim in single ephemeral element
        let interimEl = document.getElementById('interim');
        if(!interimEl){ interimEl = document.createElement('div'); interimEl.id='interim'; interimEl.className='line'; transcriptEl.appendChild(interimEl); }
        interimEl.innerHTML = `【${new Date().toLocaleTimeString()}】 <em>(interim)</em> ${escapeHtml(text)}`;
        transcriptEl.scrollTop = transcriptEl.scrollHeight;
      }
    }
  };

  try{
    recognition.start();
    statusText.textContent = 'starting';
  }catch(e){ console.error(e); }

  // start audio meter
  try{
    mediaStream = await navigator.mediaDevices.getUserMedia({audio:true});
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const source = audioContext.createMediaStreamSource(mediaStream);
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 256;
    source.connect(analyser);
    monitorVolume();
  }catch(e){ console.warn('Mic permission denied or unavailable', e); }
}

function stopRecognition(){
  if(recognition){
    try{ recognition.onresult = null; recognition.stop(); }catch(e){}
    recognition = null;
  }
  if(mediaStream){
    mediaStream.getTracks().forEach(t=>t.stop());
    mediaStream=null;
  }
  if(audioContext){ audioContext.close(); audioContext=null; }
  if(rafId) cancelAnimationFrame(rafId);
  vu.style.width = '0%';
  statusText.textContent = 'stopped';
}

function monitorVolume(){
  if(!analyser) return;
  const data = new Uint8Array(analyser.frequencyBinCount);
  analyser.getByteFrequencyData(data);
  let sum = 0; for(let i=0;i<data.length;i++) sum += data[i];
  const avg = sum / data.length;
  const pct = Math.min(100, Math.max(0, (avg / 255) * 100));
  document.getElementById('vu').style.width = pct + '%';
  rafId = requestAnimationFrame(monitorVolume);
}

btnStart.addEventListener('click', ()=>{
  startRecognition();
});
btnStop.addEventListener('click', ()=>{ stopRecognition(); });
btnClear.addEventListener('click', ()=>{ transcriptEl.innerHTML = ''; });

btnDownload.addEventListener('click', ()=>{
  const lines = Array.from(transcriptEl.querySelectorAll('.line')).map(n => n.textContent.trim());
  const blob = new Blob([lines.join('\n')], {type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'transcript.txt';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

// Clean up on page unload
window.addEventListener('beforeunload', ()=>{ stopRecognition(); });

</script>
</body>
</html>
